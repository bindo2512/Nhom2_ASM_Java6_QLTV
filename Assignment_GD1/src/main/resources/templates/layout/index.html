<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" th:fragment="dynamic(main)">
<head>
<meta charset="UTF-8">
<title>Book it NOW!</title>
<link rel="icon" type="image/x-icon" href="https://st2.depositphotos.com/1353632/9797/v/450/depositphotos_97976010-stock-illustration-architecture-symbol-circle.jpg">
<!-- Link to FontAwesome CSS -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

<!-- Liên kết Boostrap 5 -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
	crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<!-- Liên kết Scroll -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Josefin Sans'
rel='stylesheet'>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<script
src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="//cdn.ckeditor.com/4.21.0/standard/ckeditor.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init();</script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

<!-- PDFJS -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.7.570/build/pdf.min.js"></script>
<!-- Turn.js -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4/turn.min.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4/turn.min.js"></script>

<!-- Konva.js -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/konva@8.0.2/konva.min.js"></script>

<!-- Chart.Js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js" integrity="sha512-7U4rRB8aGAHGVad3u2jiC7GA5/1YhQcQjxKeaVms/bT66i3LVBMRcBI9KwABNWnxOSwulkuSXxZLGuyfvo7V1A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<body ng-app="library-app" ng-controller="library-ctrl">
	<nav>
		<div th:replace="/layout/_navbar.html"></div>
	</nav>
		<main th:replace="${main}" ></main>
	</div>
	<footer>
		<div th:replace="/layout/_footer.html"></div>
	</footer>
	<script type="text/javascript">
		const app = angular.module("library-app", []);

app.controller("library-ctrl", function($scope, $http, $document){


    $scope.cart = {
        items: [],
		number: 0,
		init() {
			$http.get("/rest/categories").then(resp => {
            $scope.categories = resp.data;
        })
		},
        add(bookid) {

            var item = this.items.find(item => item.bookid == bookid);
			if (item) {
				alert("Bạn chỉ được mượn 1 quyển sách cùng loại vào 1 thời điểm")
			} else {
				$http.get(`/rest/book/${bookid}`).then(resp => {
					resp.data.qty = 1;
					this.items.push(resp.data);
					this.saveStorage();
				})
			}
        },
		remove(id) {
			var index = this.items.findIndex(item => item.bookid == id);
			this.items.splice(index, 1);
			this.saveStorage();
		},
		clear(){
			this.items = [];
			localStorage.clear();
			this.saveStorage();
		},
		count() {
			return this.items.length;
		},
		saveStorage() {
			var json = JSON.stringify(angular.copy(this.items));
			localStorage.setItem("cart", json);
		},
		loadStorage() {
			var json = localStorage.getItem("cart")
			this.items = json ? JSON.parse(json) : [];
		},
    }
	$scope.retail = {
		retaildate: "",
		returndate: new Date(),
		fullname:"",
		address:"",
		phonenumber:"",
		email: "",
		orderstate: {orderstateid: '1'},
		updateReturnDate: function() {
    	if ($scope.retail.returndate) {
			$scope.retail.returndate = new Date($scope.retail.retaildate);
			$scope.retail.returndate.setMonth($scope.retail.retaildate.getMonth() + 1);
    	}
		return $scope.retail.returndate
	},
		accounts: {username: $("#username").text()},
		get details(){
			return $scope.cart.items.map(item => {
				return {
					books: {bookid: item.bookid},
				}
			})
		},
		rental() {
			var rental = angular.copy(this);
			$http.post("/rest/rental", rental).then(resp => {
				alert("Đặt mượn thành công, hãy đến thư viện để trực tiếp nhận sách");
				$scope.cart.clear();
				location.href = "/user/rental/detail/" + resp.data.retailid;
			}).catch(error => {
				alert("Đặt sách lỗi");
				console.log(error)
			})
		}
	}
	$scope.expandText = {'overflow': 'hidden', 'text-overflow': 'ellipsis', 'display': '-webkit-box', '-webkit-line-clamp': '3', '-webkit-box-orient': 'vertical'};
  	$scope.buttonText = 'More';
	  $scope.buttonText = 'More';

	$scope.toggleText = function() {
	if ($scope.expandText['overflow'] === 'hidden') {
		$scope.expandText = {'overflow': 'visible'};
      	$scope.buttonText = 'Less';
	} else {
		$scope.expandText = {'overflow': 'hidden', 'text-overflow': 'ellipsis', 'display': '-webkit-box', '-webkit-line-clamp': '3', '-webkit-box-orient': 'vertical'};
      $scope.buttonText = 'More';
	}
	};


	console.log($scope.isLogin)
	$scope.cart.init();
	$scope.cart.loadStorage();
})
	</script>
	<script th:src="@{|/assest/js/adminBook/script.js|}"></script>
	<script th:src="@{|/assest/js/adminRental/script.js|}"></script>
	<script th:src="@{|/assest/js/rentalHistory/script.js|}" type="text/javascript"></script>
	<script th:src="@{|/assest/js/adminAccount/script.js|}"></script>
	<script th:src="@{|/assest/js/pdfRead/script.js|}"></script>
	<script th:src="@{|/assest/js/bookDetail/script.js|}"></script>
	<script th:src="@{|/assest/js/forgotPass/forgotPass.js|}"></script>
</body>
</html>